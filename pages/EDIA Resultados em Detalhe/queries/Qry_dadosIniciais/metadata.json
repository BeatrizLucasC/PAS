{
  "gitSyncId": "69774ae9b3e043360037aa21_b1237d03-1ad3-48a8-9bb8-e9473620f31e",
  "id": "EDIA Resultados em Detalhe_Qry_dadosIniciais",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH filtros_raw AS (\n  SELECT\n    sf.id_utilizador,\n    sf.ano,\n    sf.data_registo,\n\n    -- CSV certificacoes -> rótulos legíveis\n    array_to_string(\n      ARRAY(\n        SELECT CASE TRIM(val)\n          WHEN 'globalgap' THEN 'GLOBALG.A.P.'\n          WHEN 'grasp'     THEN 'GRASP'\n          WHEN 'spring'    THEN 'SPRING'\n          WHEN 'prodi'     THEN 'PRODI'\n          ELSE INITCAP(REPLACE(TRIM(val), '_', ' '))\n        END\n        FROM unnest(string_to_array(COALESCE(sf.certificacoes, ''), ',')) AS val\n        WHERE TRIM(val) <> ''\n      ),\n      ', '\n    ) AS certificacoes_legivel,\n\n    -- CSV sistemas_producao -> rótulos legíveis\n    array_to_string(\n      ARRAY(\n        SELECT CASE TRIM(val)\n          WHEN 'sp_culturas_anuais'      THEN 'Culturas anuais'\n          WHEN 'sp_culturas_permanentes' THEN 'Culturas permanentes'\n          WHEN 'sp_producao_animal'      THEN 'Produção animal'\n          ELSE INITCAP(REPLACE(TRIM(val), '_', ' '))\n        END\n        FROM unnest(string_to_array(COALESCE(sf.sistemas_producao, ''), ',')) AS val\n        WHERE TRIM(val) <> ''\n      ),\n      ', '\n    ) AS sistemas_producao_legivel,\n\n    -- dimensão -> rótulo legível\n    CASE TRIM(COALESCE(sf.dimensao, ''))\n      WHEN 'de_pequena' THEN 'Pequena'\n      WHEN 'de_media'   THEN 'Média'\n      WHEN 'de_grande'  THEN 'Grande'\n      WHEN ''           THEN NULL\n      ELSE INITCAP(REPLACE(TRIM(sf.dimensao), '_', ' '))\n    END AS dimensao_legivel,\n\n    -- CSV mão de obra -> rótulos legíveis\n    array_to_string(\n      ARRAY(\n        SELECT CASE TRIM(val)\n          WHEN 'mao_de_obra_assalariada' THEN 'Mão de obra assalariada'\n          WHEN 'mao_de_obra_familiar'    THEN 'Mão de obra familiar'\n          ELSE INITCAP(REPLACE(TRIM(val), '_', ' '))\n        END\n        FROM unnest(string_to_array(COALESCE(sf.mao_de_obra, ''), ',')) AS val\n        WHERE TRIM(val) <> ''\n      ),\n      ', '\n    ) AS mao_de_obra_legivel,\n\n    -- Binário organizacao_prod -> rótulo legível\n    CASE TRIM(COALESCE(sf.organizacao_prod, ''))\n      WHEN 'op_sim' THEN 'Sim'\n      WHEN 'op_nao' THEN 'Não'\n      WHEN ''       THEN NULL\n      ELSE INITCAP(REPLACE(TRIM(sf.organizacao_prod), '_', ' '))\n    END AS organizacao_prod_legivel,\n\n    CASE TRIM(COALESCE(sf.prox_residencias, ''))\n      WHEN 'prox_residencias_sim' THEN 'Sim, residências ou comunidades a < 250 m das extremidades da exploração.'\n      WHEN 'prox_residencias_nao' THEN 'Não, comunidades a > 250 m das extremidades da exploração.'\n      WHEN ''                     THEN NULL\n      ELSE INITCAP(REPLACE(TRIM(sf.prox_residencias), '_', ' '))\n    END AS prox_residencias_legivel,\n\n    CASE TRIM(COALESCE(sf.fitofarmaceuticos, ''))\n      WHEN 'fitofarmaceuticos_sim' THEN 'Sim'\n      WHEN 'fitofarmaceuticos_nao' THEN 'Não'\n      WHEN ''                      THEN NULL\n      ELSE INITCAP(REPLACE(TRIM(sf.fitofarmaceuticos), '_', ' '))\n    END AS fitofarmaceuticos_legivel,\n\n    CASE TRIM(COALESCE(sf.aguas_residuais, ''))\n      WHEN 'aguas_residuais_sim' THEN 'Sim'\n      WHEN 'aguas_residuais_nao' THEN 'Não'\n      WHEN ''                    THEN NULL\n      ELSE INITCAP(REPLACE(TRIM(sf.aguas_residuais), '_', ' '))\n    END AS aguas_residuais_legivel,\n\n    CASE TRIM(COALESCE(sf.consumo_energetico, ''))\n      WHEN 'consumo_energetico_sim' THEN 'Sim'\n      WHEN 'consumo_energetico_nao' THEN 'Não'\n      WHEN ''                       THEN NULL\n      ELSE INITCAP(REPLACE(TRIM(sf.consumo_energetico), '_', ' '))\n    END AS consumo_energetico_legivel\n\n  FROM selecoes_filtros sf\n  WHERE sf.id_utilizador = '{{Tbl_resumo.selectedRow.nif}}'\n    AND sf.ano = {{ Select_year.selectedOptionValue }}\n),\n\n-- Último registo para o par (utilizador, ano)\nfiltros AS (\n  SELECT DISTINCT ON (fr.id_utilizador, fr.ano)\n    fr.*\n  FROM filtros_raw fr\n  ORDER BY fr.id_utilizador, fr.ano, fr.data_registo DESC\n)\n\nSELECT\n  certificacoes_legivel,\n  sistemas_producao_legivel,\n  dimensao_legivel,\n  mao_de_obra_legivel,\n  organizacao_prod_legivel,\n  prox_residencias_legivel,\n  fitofarmaceuticos_legivel,\n  aguas_residuais_legivel,\n  consumo_energetico_legivel\nFROM filtros fr;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "pg_alquevaustentavel",
      "isAutoGenerated": false,
      "name": "pg_alquevaustentavel",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Qry_dadosIniciais",
    "pageId": "EDIA Resultados em Detalhe",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}