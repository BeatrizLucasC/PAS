{
  "gitSyncId": "69774ae9b3e043360037aa21_5c55b25c-33b0-4ba5-a2c4-f11c34ed9df1",
  "id": "EDIA ValidaÃ§Ã£o e Consulta_Qry_controlo",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH contagens AS (\n  SELECT\n    r.id_utilizador,\n    COUNT(*) AS respostas_total,\n    SUM(CASE WHEN r.validacao = 'S' THEN 1 ELSE 0 END) AS respostas_validadas,\n    SUM(CASE WHEN r.validacao = 'N' THEN 1 ELSE 0 END) AS respostas_nao_validadas,\n    MAX(r.data_hora_submissao) AS ultima_submissao_utc\n  FROM respostas r\n  WHERE r.ano = {{ Select_year.selectedOptionValue }}\n  GROUP BY r.id_utilizador\n),\n\nultima_validacao AS (\n  SELECT DISTINCT ON (r.id_utilizador)\n    r.id_utilizador,\n    r.data_hora_validacao AS ultima_validacao_utc,\n    r.tecnico_validacao\n  FROM respostas r\n  WHERE r.ano = {{ Select_year.selectedOptionValue }}\n    AND r.validacao = 'S'\n    AND r.data_hora_validacao IS NOT NULL\n  ORDER BY r.id_utilizador, r.data_hora_validacao DESC\n),\n\n/* CTE para mÃ©tricas dos domÃ­nios */\nform_estado AS (\n  SELECT\n    r.id_utilizador,\n    COUNT(*) FILTER (\n      WHERE LOWER(TRIM(r.dominio)) IN ('ambiental','social','economico')\n    ) AS total_3d,\n\n    COUNT(*) FILTER (\n      WHERE LOWER(TRIM(r.dominio)) IN ('ambiental','social','economico')\n        AND r.validacao = 'S'\n    ) AS total_validadas_3d,\n\n    COUNT(DISTINCT LOWER(TRIM(r.dominio))) FILTER (\n      WHERE LOWER(TRIM(r.dominio)) IN ('ambiental','social','economico')\n    ) AS dominios_respondidos_3d\n  FROM respostas r\n  WHERE r.ano = {{ Select_year.selectedOptionValue }}\n  GROUP BY r.id_utilizador\n),\n\n/* Novo: CTE que constrÃ³i a lista de domÃ­nios distintos e ordenados por utilizador */\ndominios_por_utilizador AS (\n  SELECT\n    d.id_utilizador,\n    STRING_AGG(d.lbl, ', ' ORDER BY d.ord) AS dominios_list\n  FROM (\n    SELECT DISTINCT\n      r.id_utilizador,\n      CASE LOWER(TRIM(r.dominio))\n        WHEN 'ambiental' THEN 'Ambiental'\n        WHEN 'social'    THEN 'Social'\n        WHEN 'economico' THEN 'EconÃ³mico'\n        ELSE NULL\n      END AS lbl,\n      CASE LOWER(TRIM(r.dominio))\n        WHEN 'ambiental' THEN 1\n        WHEN 'social'    THEN 2\n        WHEN 'economico' THEN 3\n        ELSE 99\n      END AS ord\n    FROM respostas r\n    WHERE r.ano = {{ Select_year.selectedOptionValue }}\n      AND LOWER(TRIM(r.dominio)) IN ('ambiental','social','economico')\n  ) d\n  WHERE d.lbl IS NOT NULL\n  GROUP BY d.id_utilizador\n)\n\nSELECT\n  COALESCE(u.nome, c.id_utilizador::text) AS nome,\n  c.id_utilizador AS nif,\n\n  -- KPIs\n  c.respostas_total,\n  c.respostas_validadas,\n  c.respostas_nao_validadas,\n\n  -- Ãšltima submissÃ£o convertida para Europe/Lisbon\n  TO_CHAR(\n    (c.ultima_submissao_utc AT TIME ZONE 'UTC') AT TIME ZONE 'Europe/Lisbon',\n    'DD/MM/YYYY - HH24:MI:SS'\n  ) AS ultima_submissao,\n\n  -- TÃ©cnico e data da Ãºltima validaÃ§Ã£o\n  COALESCE(utech.nome, 'â€”') AS tecnico_validacao_nome,\n  COALESCE(\n    TO_CHAR(\n      (uv.ultima_validacao_utc AT TIME ZONE 'UTC') AT TIME ZONE 'Europe/Lisbon',\n      'DD/MM/YYYY - HH24:MI:SS'\n    ),\n    'ValidaÃ§Ã£o pendente'\n  ) AS data_ultima_validacao,\n\n  -- Estado do formulÃ¡rio (como tinhas)\n  CASE\n    WHEN fs.dominios_respondidos_3d = 3\n     AND fs.total_3d > 0\n     AND fs.total_3d = fs.total_validadas_3d\n      THEN 'Validado'\n    ELSE 'Por validar'\n  END AS validacao_form,\n\n  -- ðŸ‘‰ Novo: DomÃ­nios submetidos + \"Form. completo|incompleto\"\n  COALESCE(\n    REGEXP_REPLACE(dp.dominios_list, ', (?=[^,]+$)', ' e '),\n    'â€”'\n  )\n  || ' - '\n  || CASE\n       WHEN COALESCE(fs.dominios_respondidos_3d, 0) = 3\n         THEN 'Form. completo'\n       ELSE 'Form. incompleto'\n     END AS dominios_submetidos\n\nFROM contagens c\nLEFT JOIN utilizadores u\n  ON u.nif = c.id_utilizador\nLEFT JOIN ultima_validacao uv\n  ON uv.id_utilizador = c.id_utilizador\nLEFT JOIN utilizadores utech\n  ON utech.nif = uv.tecnico_validacao\nLEFT JOIN form_estado fs\n  ON fs.id_utilizador = c.id_utilizador\nLEFT JOIN dominios_por_utilizador dp\n  ON dp.id_utilizador = c.id_utilizador\n\nORDER BY\n  c.respostas_validadas DESC,\n  COALESCE(u.nome, c.id_utilizador::text) ASC;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "pg_alquevaustentavel",
      "isAutoGenerated": false,
      "name": "pg_alquevaustentavel",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Qry_controlo",
    "pageId": "EDIA ValidaÃ§Ã£o e Consulta",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": true
  }
}