WITH ultimas_respostas AS (
  SELECT
    r.*,
    ROW_NUMBER() OVER (
      PARTITION BY r.id_pergunta, r.id_utilizador, r.ano
      ORDER BY r.data_hora_submissao DESC
    ) AS rn
  FROM respostas r
  WHERE r.id_utilizador = '{{Tbl_resumo.selectedRow.nif}}'
    AND r.ano = '{{Select_year.selectedOptionValue}}'
)
SELECT
  p.id_pergunta,
  p.pergunta,
  p.dominio,
  p.categoria,
  p.indicador,
  ur.resposta,
  CASE
    WHEN ur.validacao = 'S' THEN 'Validada'
    WHEN ur.validacao = 'N' THEN 'Por validar'
    ELSE ur.validacao
  END AS validacao
FROM perguntas p
INNER JOIN ultimas_respostas ur
  ON ur.id_pergunta = p.id_pergunta
 AND ur.rn = 1
ORDER BY
  CASE WHEN ur.validacao = 'N' THEN 0 ELSE 1 END,
  p.id_pergunta;