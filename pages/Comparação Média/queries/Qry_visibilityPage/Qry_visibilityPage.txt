WITH por_dom AS (
  SELECT
    ano,
    id_utilizador,
    dominio,
    BOOL_AND(validacao = 'S') AS dominio_validado
  FROM respostas
  WHERE dominio IN ('ambiental','social','economico')
  GROUP BY ano, id_utilizador, dominio
),
por_user AS (
  SELECT
    ano,
    id_utilizador,
    COUNT(*) AS dominios_encontrados,
    BOOL_AND(dominio_validado) AS todos_dominios_validos
  FROM por_dom
  GROUP BY ano, id_utilizador
),
users_validos AS (
  SELECT ano, id_utilizador
  FROM por_user
  WHERE dominios_encontrados = 3        -- tem os 3 domínios
    AND todos_dominios_validos = TRUE   -- e todos eles só com 'S'
)
SELECT
  ano,
  COUNT(DISTINCT id_utilizador)        AS n_utilizadores_validos,
  (COUNT(DISTINCT id_utilizador) >= 1) AS ano_ok
FROM users_validos
GROUP BY ano
ORDER BY ano DESC;