{
  "gitSyncId": "69774ae9b3e043360037aa21_fcc89b9c-2f26-44e7-a141-1eb368b65de8",
  "id": "Preenchimento de Formul치rio_Qry_saveAnswersAmbiental",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH payload (\n  id_resposta,\n  id_pergunta,\n  id_utilizador,\n  resposta,\n  data_hora_submissao,\n  ano,\n  dominio,\n  validacao\n) AS (\n  VALUES\n  {{ JS_regrasAmbiental.buildValues({ onlyVisible: true }) }}\n),\nhas_payload AS (\n  SELECT EXISTS (SELECT 1 FROM payload) AS ok\n),\nupsert AS (\n  INSERT INTO respostas (\n    id_resposta,\n    id_pergunta,\n    id_utilizador,\n    resposta,\n    data_hora_submissao,\n    ano,\n    dominio,\n    validacao\n  )\n  SELECT\n    p.id_resposta,\n    p.id_pergunta,\n    p.id_utilizador,\n    p.resposta,\n    NOW(),\n    p.ano,\n    p.dominio,\n    COALESCE(p.validacao, 'N')\n  FROM payload p\n  ON CONFLICT (id_resposta) DO UPDATE\n  SET\n    resposta            = EXCLUDED.resposta,\n    data_hora_submissao = NOW(),\n    dominio             = EXCLUDED.dominio,\n    validacao           = 'N'\n  WHERE respostas.resposta IS DISTINCT FROM EXCLUDED.resposta\n)\nDELETE FROM respostas r\nUSING (\n  SELECT DISTINCT id_utilizador, ano, dominio FROM payload\n) ctx,\nhas_payload hp\nWHERE\n  hp.ok = true                                    -- s칩 limpa se h치 payload real\n  AND r.id_utilizador = ctx.id_utilizador\n  AND r.ano           = ctx.ano\n  AND r.dominio       = ctx.dominio\n  AND NOT EXISTS (\n    SELECT 1\n    FROM payload p\n    WHERE p.id_pergunta = r.id_pergunta\n  );",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "pg_alquevaustentavel",
      "isAutoGenerated": false,
      "name": "pg_alquevaustentavel",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Qry_saveAnswersAmbiental",
    "pageId": "Preenchimento de Formul치rio",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}