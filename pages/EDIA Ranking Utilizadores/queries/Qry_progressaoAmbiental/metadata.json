{
  "gitSyncId": "69774ae9b3e043360037aa21_bba28f9b-8e4a-4cbe-bacc-8935f9faf82f",
  "id": "EDIA Ranking Utilizadores_Qry_progressaoAmbiental",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH params AS (\n  SELECT \n    {{ Number(Select_year.selectedOptionValue) }} AS ano_sel,\n    {{ Number(Select_year.selectedOptionValue) }} - 1 AS ano_prev\n),\nbase AS (\n  SELECT\n    v.id_utilizador,\n    v.dominio,\n    v.ano,\n    COALESCE(v.pontuacao_user, 0) AS pontuacao\n  FROM vw_score_user_avg_dominio v\n  WHERE v.ano IN ((SELECT ano_sel FROM params), (SELECT ano_prev FROM params))\n    AND v.dominio = 'Ambiental'\n),\ncomparacao AS (\n  SELECT\n    b.id_utilizador,\n    b.dominio,\n    b.ano,\n    b.pontuacao AS pontuacao_atual,\n    LAG(b.pontuacao) OVER (PARTITION BY b.id_utilizador, b.dominio ORDER BY b.ano) AS pontuacao_anterior_num\n  FROM base b\n)\nSELECT\n  c.id_utilizador,\n  c.dominio,\n  (SELECT ano_sel FROM params)::text || '-' || (SELECT ano_prev FROM params)::text AS anos,\n  c.pontuacao_atual,\n  CASE WHEN c.pontuacao_anterior_num IS NULL THEN 'N達o existem dados para o ano anterior'\n       ELSE TO_CHAR(c.pontuacao_anterior_num, 'FM999999990D00') END AS pontuacao_anterior,\n  CASE WHEN c.pontuacao_anterior_num IS NULL THEN 'N達o existem dados para o ano anterior'\n       ELSE TO_CHAR((COALESCE(c.pontuacao_atual, 0) - COALESCE(c.pontuacao_anterior_num, 0)), 'FM999999990D00') END AS variacao_abs,\n  CASE WHEN c.pontuacao_anterior_num IS NULL OR c.pontuacao_anterior_num = 0 THEN 'N達o existem dados para o ano anterior'\n       ELSE TO_CHAR(((c.pontuacao_atual - c.pontuacao_anterior_num) / c.pontuacao_anterior_num) * 100, 'FM999999990D00') || '%' END AS variacao_pct,\n  CASE WHEN c.pontuacao_anterior_num IS NULL THEN 'N達o existem dados para o ano anterior'\n       ELSE (DENSE_RANK() OVER (PARTITION BY c.dominio, c.ano\n                                ORDER BY (COALESCE(c.pontuacao_atual, 0) - COALESCE(c.pontuacao_anterior_num, 0)) DESC))::text END AS posicao\nFROM comparacao c\nWHERE c.ano = (SELECT ano_sel FROM params)\nORDER BY (COALESCE(c.pontuacao_atual, 0) - COALESCE(c.pontuacao_anterior_num, 0)) DESC,\n         c.id_utilizador ASC;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "pg_alquevaustentavel",
      "isAutoGenerated": false,
      "name": "pg_alquevaustentavel",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Qry_progressaoAmbiental",
    "pageId": "EDIA Ranking Utilizadores",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}