WITH params AS (
  SELECT 
    /* Garante que o valor do select é numérico */
    {{ Number(Select_year.selectedOptionValue) }} AS ano_sel,
    {{ Number(Select_year.selectedOptionValue) }} - 1 AS ano_prev
),
base AS (
  SELECT
    v.id_utilizador,
    v.ano,
    COALESCE(v.pontuacao_user, 0) AS pontuacao
  FROM vw_score_user_avg_global v
  WHERE v.ano IN (
    (SELECT ano_sel FROM params),
    (SELECT ano_prev FROM params)
  )
),
comparacao AS (
  SELECT
    b.id_utilizador,
    b.ano,
    b.pontuacao AS pontuacao_atual,
    LAG(b.pontuacao) OVER (PARTITION BY b.id_utilizador ORDER BY b.ano) AS pontuacao_anterior_num
  FROM base b
)
SELECT
  c.id_utilizador,
  /* Substitui 'ano' por 'anos' no formato 2025-2024 */
  (SELECT ano_sel FROM params)::text || '-' || (SELECT ano_prev FROM params)::text AS anos,

  /* Pontuação do ano atual (mantém como número) */
  c.pontuacao_atual,

  /* Pontuação do ano anterior: texto quando não existe */
  CASE
    WHEN c.pontuacao_anterior_num IS NULL
      THEN 'Não existem dados para o ano anterior'
    ELSE TO_CHAR(c.pontuacao_anterior_num, 'FM999999990D00')
  END AS pontuacao_anterior,

  /* Variação absoluta: texto quando não existe ano anterior */
  CASE
    WHEN c.pontuacao_anterior_num IS NULL
      THEN 'Não existem dados para o ano anterior'
    ELSE TO_CHAR((COALESCE(c.pontuacao_atual, 0) - COALESCE(c.pontuacao_anterior_num, 0)), 'FM999999990D00')
  END AS variacao_abs,

  /* Variação percentual: texto quando não existe ano anterior ou é zero */
  CASE
    WHEN c.pontuacao_anterior_num IS NULL OR c.pontuacao_anterior_num = 0
      THEN 'Não existem dados para o ano anterior'
    ELSE TO_CHAR(((c.pontuacao_atual - c.pontuacao_anterior_num) / c.pontuacao_anterior_num) * 100, 'FM999999990D00') || '%'
  END AS variacao_pct,

  /* Posição no ranking de progressão: texto quando não existe ano anterior */
  CASE
    WHEN c.pontuacao_anterior_num IS NULL
      THEN 'Não existem dados para o ano anterior'
    ELSE (DENSE_RANK() OVER (
            PARTITION BY c.ano
            ORDER BY (COALESCE(c.pontuacao_atual, 0) - COALESCE(c.pontuacao_anterior_num, 0)) DESC
          ))::text
  END AS posicao
FROM comparacao c
/* Apenas o ano selecionado (onde está o delta) */
WHERE c.ano = (SELECT ano_sel FROM params)

/* Ordenação por maior progressão absoluta (usando expressão numérica, sem criar coluna extra) */
ORDER BY
  (COALESCE(c.pontuacao_atual, 0) - COALESCE(c.pontuacao_anterior_num, 0)) DESC,
  c.id_utilizador ASC;