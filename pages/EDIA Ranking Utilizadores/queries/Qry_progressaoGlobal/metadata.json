{
  "gitSyncId": "69774ae9b3e043360037aa21_5cd1e82e-8d6d-4ad2-b7cc-923e16e0cf31",
  "id": "EDIA Ranking Utilizadores_Qry_progressaoGlobal",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH params AS (\n  SELECT \n    /* Garante que o valor do select é numérico */\n    {{ Number(Select_year.selectedOptionValue) }} AS ano_sel,\n    {{ Number(Select_year.selectedOptionValue) }} - 1 AS ano_prev\n),\nbase AS (\n  SELECT\n    v.id_utilizador,\n    v.ano,\n    COALESCE(v.pontuacao_user, 0) AS pontuacao\n  FROM vw_score_user_avg_global v\n  WHERE v.ano IN (\n    (SELECT ano_sel FROM params),\n    (SELECT ano_prev FROM params)\n  )\n),\ncomparacao AS (\n  SELECT\n    b.id_utilizador,\n    b.ano,\n    b.pontuacao AS pontuacao_atual,\n    LAG(b.pontuacao) OVER (PARTITION BY b.id_utilizador ORDER BY b.ano) AS pontuacao_anterior_num\n  FROM base b\n)\nSELECT\n  c.id_utilizador,\n  /* Substitui 'ano' por 'anos' no formato 2025-2024 */\n  (SELECT ano_sel FROM params)::text || '-' || (SELECT ano_prev FROM params)::text AS anos,\n\n  /* Pontuação do ano atual (mantém como número) */\n  c.pontuacao_atual,\n\n  /* Pontuação do ano anterior: texto quando não existe */\n  CASE\n    WHEN c.pontuacao_anterior_num IS NULL\n      THEN 'Não existem dados para o ano anterior'\n    ELSE TO_CHAR(c.pontuacao_anterior_num, 'FM999999990D00')\n  END AS pontuacao_anterior,\n\n  /* Variação absoluta: texto quando não existe ano anterior */\n  CASE\n    WHEN c.pontuacao_anterior_num IS NULL\n      THEN 'Não existem dados para o ano anterior'\n    ELSE TO_CHAR((COALESCE(c.pontuacao_atual, 0) - COALESCE(c.pontuacao_anterior_num, 0)), 'FM999999990D00')\n  END AS variacao_abs,\n\n  /* Variação percentual: texto quando não existe ano anterior ou é zero */\n  CASE\n    WHEN c.pontuacao_anterior_num IS NULL OR c.pontuacao_anterior_num = 0\n      THEN 'Não existem dados para o ano anterior'\n    ELSE TO_CHAR(((c.pontuacao_atual - c.pontuacao_anterior_num) / c.pontuacao_anterior_num) * 100, 'FM999999990D00') || '%'\n  END AS variacao_pct,\n\n  /* Posição no ranking de progressão: texto quando não existe ano anterior */\n  CASE\n    WHEN c.pontuacao_anterior_num IS NULL\n      THEN 'Não existem dados para o ano anterior'\n    ELSE (DENSE_RANK() OVER (\n            PARTITION BY c.ano\n            ORDER BY (COALESCE(c.pontuacao_atual, 0) - COALESCE(c.pontuacao_anterior_num, 0)) DESC\n          ))::text\n  END AS posicao\nFROM comparacao c\n/* Apenas o ano selecionado (onde está o delta) */\nWHERE c.ano = (SELECT ano_sel FROM params)\n\n/* Ordenação por maior progressão absoluta (usando expressão numérica, sem criar coluna extra) */\nORDER BY\n  (COALESCE(c.pontuacao_atual, 0) - COALESCE(c.pontuacao_anterior_num, 0)) DESC,\n  c.id_utilizador ASC;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "pg_alquevaustentavel",
      "isAutoGenerated": false,
      "name": "pg_alquevaustentavel",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Qry_progressaoGlobal",
    "pageId": "EDIA Ranking Utilizadores",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}